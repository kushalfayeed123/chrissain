<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KiraCoin Exchange</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <!-- Ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <!-- WalletConnect Ethereum Provider v2 -->
    <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.1.8/dist/umd/index.min.js"></script>
    <!-- Reown AppKit libraries (UMD builds) -->
    <script src="https://unpkg.com/@reown/appkit@latest/dist/index.umd.min.js"></script>
    <script src="https://unpkg.com/@reown/appkit-adapter-wagmi@latest/dist/index.umd.min.js"></script>
    <script src="https://unpkg.com/@reown/appkit/networks@latest/dist/index.umd.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8f9fa;
      }
      .navbar {
        background-color: #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
      }
      .bg-primary {
        background-image: linear-gradient(152deg, #590202 0%, #a61103 100%);
      }
      .btn-primary {
        background-image: linear-gradient(152deg, #590202 0%, #a61103 100%);
      }
      /* Connect Wallet button placed at the very top */
      #open-connect-modal {
        display: block;
        margin: 1rem auto;
      }
      #mobileWarning {
        text-align: center;
        margin: 0.5rem;
      }
    </style>
  </head>
  <body>
    <!-- Connect Wallet Button at the Top -->
    <div style="text-align: center; margin-top: 1rem">
      <button id="open-connect-modal" class="btn btn-primary">
        Connect Wallet
      </button>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg py-3">
      <div class="container">
        <a class="navbar-brand fw-bold text-dark" href="#">
          KiraCoin Exchange
        </a>
        <div id="walletAddress" class="badge bg-light text-dark p-2">
          Not connected
        </div>
      </div>
    </nav>

    <!-- Mobile Warning Banner (if needed) -->
    <div id="mobileWarning" style="display: none">
      For optimal wallet connectivity on mobile, please use a walletâ€‘enabled
      browser.
    </div>

    <!-- Main Container -->
    <div class="container my-5">
      <!-- Stats Section -->
      <div class="row g-4 mb-4">
        <div class="col-12">
          <div class="card bg-primary text-white">
            <div class="row text-center">
              <div class="col-md-4">
                <h6>Current Price</h6>
                <h3>$<span id="currentPrice">0.00</span></h3>
              </div>
              <div class="col-md-4">
                <h6>Available Supply</h6>
                <h3><span id="availableSupply">0</span> KIRA</h3>
              </div>
              <div class="col-md-4">
                <h6>Total Sold</h6>
                <h3><span id="totalSold">0</span> KIRA</h3>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Purchase Sections -->
      <div class="row g-4">
        <!-- Buy with Stablecoins -->
        <div class="col-md-6">
          <div class="card">
            <h4 class="mb-4">Buy with Stablecoins</h4>
            <div class="mb-3">
              <label class="form-label">Select Stablecoin</label>
              <select id="stablecoinSelect" class="form-select">
                <option value="BUSD">BUSD</option>
                <option value="USDT">USDT</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Amount to Spend (USD)</label>
              <input
                type="number"
                id="stablecoinAmount"
                class="form-control"
                placeholder="Enter USD amount"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">KIRA Tokens You Will Receive</label>
              <input
                type="text"
                id="stablecoinKiraPreview"
                class="form-control"
                placeholder="0.00"
                readonly
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Equivalent in USD</label>
              <input
                type="text"
                id="stablecoinUsdPreview"
                class="form-control"
                placeholder="$0.00"
                readonly
              />
            </div>
            <button id="buyStablecoinButton" class="btn btn-primary w-100">
              Approve &amp; Buy KIRA
            </button>
          </div>
        </div>

        <!-- Buy with Native Currency (BNB) -->
        <div class="col-md-6">
          <div class="card">
            <h4 class="mb-4">Buy with BNB</h4>
            <div class="mb-3">
              <label class="form-label">Amount to Spend (USD)</label>
              <input
                type="number"
                id="bnbUsdAmount"
                class="form-control"
                placeholder="Enter USD amount"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">KIRA Tokens You Will Receive</label>
              <input
                type="text"
                id="bnbKiraPreview"
                class="form-control"
                placeholder="0.00"
                readonly
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Equivalent in BNB</label>
              <input
                type="text"
                id="bnbEquivalentPreview"
                class="form-control"
                placeholder="0.00"
                readonly
              />
            </div>
            <button id="buyNativeButton" class="btn btn-primary w-100">
              Buy KIRA
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Reown AppKit Integration for WalletConnect v2 -->
    <script>
      // 1. Set up Reown AppKit using WalletConnect v2.
      // Get your project ID at https://cloud.reown.com
      const projectId = "35ee0797cf298b1835906b5a22bc50e5";

      // 2. Load networks from Reown AppKit (using mainnet and arbitrum as examples)
      const { mainnet, arbitrum } = window.ReownNetworks;
      const networks = [mainnet, arbitrum];

      // 3. Set up the Wagmi adapter.
      const wagmiAdapter = new window.ReownAppkitAdapterWagmi.WagmiAdapter({
        projectId,
        networks,
      });

      // 4. Configure metadata (ensure the URL exactly matches your domain).
      const metadata = {
        name: "kira",
        description: "AppKit Example",
        url: "https://chrissain.vercel.app/", // Change to your domain
        icons: ["https://assets.reown.com/reown-profile-pic.png"],
      };

      // 5. Create the modal with Reown AppKit (which uses WalletConnect v2 under the hood).
      const modal = window.ReownAppkit.createAppKit({
        adapters: [wagmiAdapter],
        networks,
        metadata,
        projectId,
        features: {
          analytics: true, // Optional
        },
      });

      // 6. Bind the Connect Wallet button to open the modal.
      const openConnectModalBtn = document.getElementById("open-connect-modal");
      openConnectModalBtn.addEventListener("click", () => {
        modal.open();
      });

      // 7. Listen for connection events (if provided by the adapter) to update the UI.
      // For example, when connected, update the wallet address and initialize contract integration.
      modal.on("connect", (account) => {
        document.getElementById("walletAddress").innerText = account;
        // Optionally initialize your contract calls here.
        initContract();
      });

      // 8. Contract Integration.
      // Update these values with your actual contract address and ABI.
      const dappContractAddress = "0xc4922B44A7109B9c77F6f77c650C5949661F874f";
      const contractABI = [
        {
          inputs: [
            { internalType: "address", name: "_priceFeed", type: "address" },
          ],
          stateMutability: "nonpayable",
          type: "constructor",
        },
        {
          inputs: [
            { internalType: "address", name: "spender", type: "address" },
            { internalType: "uint256", name: "allowance", type: "uint256" },
            { internalType: "uint256", name: "needed", type: "uint256" },
          ],
          name: "ERC20InsufficientAllowance",
          type: "error",
        },
        {
          inputs: [
            { internalType: "address", name: "sender", type: "address" },
            { internalType: "uint256", name: "balance", type: "uint256" },
            { internalType: "uint256", name: "needed", type: "uint256" },
          ],
          name: "ERC20InsufficientBalance",
          type: "error",
        },
        {
          inputs: [
            { internalType: "address", name: "approver", type: "address" },
          ],
          name: "ERC20InvalidApprover",
          type: "error",
        },
        {
          inputs: [
            { internalType: "address", name: "receiver", type: "address" },
          ],
          name: "ERC20InvalidReceiver",
          type: "error",
        },
        {
          inputs: [
            { internalType: "address", name: "sender", type: "address" },
          ],
          name: "ERC20InvalidSender",
          type: "error",
        },
        {
          inputs: [
            { internalType: "address", name: "spender", type: "address" },
          ],
          name: "ERC20InvalidSpender",
          type: "error",
        },
        { inputs: [], name: "EnforcedPause", type: "error" },
        { inputs: [], name: "ExpectedPause", type: "error" },
        {
          inputs: [{ internalType: "address", name: "owner", type: "address" }],
          name: "OwnableInvalidOwner",
          type: "error",
        },
        {
          inputs: [
            { internalType: "address", name: "account", type: "address" },
          ],
          name: "OwnableUnauthorizedAccount",
          type: "error",
        },
        { inputs: [], name: "ReentrancyGuardReentrantCall", type: "error" },
        {
          inputs: [{ internalType: "address", name: "token", type: "address" }],
          name: "SafeERC20FailedOperation",
          type: "error",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "owner",
              type: "address",
            },
            {
              indexed: true,
              internalType: "address",
              name: "spender",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "value",
              type: "uint256",
            },
          ],
          name: "Approval",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "recipient",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
            {
              indexed: false,
              internalType: "bool",
              name: "isNative",
              type: "bool",
            },
          ],
          name: "FundsWithdrawn",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "previousOwner",
              type: "address",
            },
            {
              indexed: true,
              internalType: "address",
              name: "newOwner",
              type: "address",
            },
          ],
          name: "OwnershipTransferred",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: false,
              internalType: "address",
              name: "account",
              type: "address",
            },
          ],
          name: "Paused",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "newFeed",
              type: "address",
            },
          ],
          name: "PriceFeedUpdated",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: false,
              internalType: "uint256",
              name: "newIncrementStep",
              type: "uint256",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "newMultiplier",
              type: "uint256",
            },
          ],
          name: "PriceParamsUpdated",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "token",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "decimals",
              type: "uint256",
            },
          ],
          name: "StablecoinAdded",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "token",
              type: "address",
            },
          ],
          name: "StablecoinRemoved",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "buyer",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "totalPrice",
              type: "uint256",
            },
          ],
          name: "TokensPurchased",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "address",
              name: "from",
              type: "address",
            },
            {
              indexed: true,
              internalType: "address",
              name: "to",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "value",
              type: "uint256",
            },
          ],
          name: "Transfer",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: false,
              internalType: "address",
              name: "account",
              type: "address",
            },
          ],
          name: "Unpaused",
          type: "event",
        },
        {
          inputs: [
            { internalType: "address", name: "token", type: "address" },
            {
              internalType: "uint256",
              name: "tokenDecimals",
              type: "uint256",
            },
          ],
          name: "addStablecoin",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            { internalType: "address", name: "owner", type: "address" },
            { internalType: "address", name: "spender", type: "address" },
          ],
          name: "allowance",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { internalType: "address", name: "spender", type: "address" },
            { internalType: "uint256", name: "value", type: "uint256" },
          ],
          name: "approve",
          outputs: [{ internalType: "bool", name: "", type: "bool" }],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [{ internalType: "address", name: "", type: "address" }],
          name: "approvedStablecoins",
          outputs: [{ internalType: "bool", name: "", type: "bool" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "availableSupply",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { internalType: "address", name: "account", type: "address" },
          ],
          name: "balanceOf",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { internalType: "uint256", name: "amount", type: "uint256" },
          ],
          name: "burnFromContract",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            { internalType: "uint256", name: "minTokens", type: "uint256" },
          ],
          name: "buyWithNative",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "address",
              name: "stablecoinAddress",
              type: "address",
            },
            { internalType: "uint256", name: "tokenAmount", type: "uint256" },
          ],
          name: "buyWithStablecoin",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "currentPrice",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "decimals",
          outputs: [{ internalType: "uint8", name: "", type: "uint8" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "maxPurchaseAmount",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "name",
          outputs: [{ internalType: "string", name: "", type: "string" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "owner",
          outputs: [{ internalType: "address", name: "", type: "address" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "pause",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "paused",
          outputs: [{ internalType: "bool", name: "", type: "bool" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "priceIncrementStep",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "priceMultiplier",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { internalType: "address", name: "_recipient", type: "address" },
            {
              internalType: "uint256",
              name: "_nativeAmount",
              type: "uint256",
            },
          ],
          name: "reconcileNativeCoinAccounts",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "address",
              name: "stablecoinAddress",
              type: "address",
            },
            { internalType: "address", name: "recipient", type: "address" },
            { internalType: "uint256", name: "amount", type: "uint256" },
          ],
          name: "reconcileStableCoinAccounts",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [{ internalType: "address", name: "token", type: "address" }],
          name: "recoverTokens",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "renounceOwnership",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            { internalType: "uint256", name: "newStep", type: "uint256" },
            {
              internalType: "uint256",
              name: "newMultiplier",
              type: "uint256",
            },
          ],
          name: "setPriceParams",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [{ internalType: "address", name: "", type: "address" }],
          name: "stablecoinDecimals",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "symbol",
          outputs: [{ internalType: "string", name: "", type: "string" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "totalSupply",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "totalTokensSold",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { internalType: "address", name: "to", type: "address" },
            { internalType: "uint256", name: "value", type: "uint256" },
          ],
          name: "transfer",
          outputs: [{ internalType: "bool", name: "", type: "bool" }],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            { internalType: "address", name: "from", type: "address" },
            { internalType: "address", name: "to", type: "address" },
            { internalType: "uint256", name: "value", type: "uint256" },
          ],
          name: "transferFrom",
          outputs: [{ internalType: "bool", name: "", type: "bool" }],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            { internalType: "address", name: "newOwner", type: "address" },
          ],
          name: "transferOwnership",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "unpause",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            { internalType: "address", name: "newFeed", type: "address" },
          ],
          name: "updatePriceFeed",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        { stateMutability: "payable", type: "receive" },
      ];

      let dappContract, ethersProvider, ethersSigner;

      async function initContract() {
        try {
          // Get the ethers provider from the adapter.
          ethersProvider = wagmiAdapter.getProvider();
          ethersSigner = ethersProvider.getSigner();
          dappContract = new ethers.Contract(
            dappContractAddress,
            contractABI,
            ethersSigner
          );
          // Update contract stats.
          updateContractStats();
        } catch (error) {
          console.error("Error initializing contract:", error);
        }
      }

      async function updateContractStats() {
        try {
          // Example: Call availableSupply() and update UI.
          const supply = await dappContract.availableSupply();
          document.getElementById("availableSupply").innerText =
            ethers.utils.formatUnits(supply, 18);
          // You can add more contract calls here.
        } catch (error) {
          console.error("Error updating contract stats:", error);
        }
      }
    </script>

    <!-- Existing DApp Purchase Functions -->
    <script>
      // Function to update preview for stablecoin purchase.
      function updateStablecoinPreview() {
        const usdVal = parseFloat(
          document.getElementById("stablecoinAmount").value
        );
        if (isNaN(usdVal) || usdVal <= 0) {
          document.getElementById("stablecoinKiraPreview").value = "";
          document.getElementById("stablecoinUsdPreview").value = "";
          return;
        }
        const kiraTokens = usdVal / 100; // 1 KIRA = $100 USD
        document.getElementById("stablecoinKiraPreview").value =
          kiraTokens.toFixed(4);
        document.getElementById("stablecoinUsdPreview").value =
          "$" + usdVal.toFixed(2);
      }

      // Function to update preview for native (BNB) purchase.
      async function updateNativePreview() {
        const usdVal = parseFloat(
          document.getElementById("bnbUsdAmount").value
        );
        if (isNaN(usdVal) || usdVal <= 0) {
          document.getElementById("bnbKiraPreview").value = "";
          document.getElementById("bnbEquivalentPreview").value = "";
          return;
        }
        // Assume currentPriceBN has been set via contract call.
        const usdAmountBN = ethers.utils.parseUnits(usdVal.toString(), 18);
        const expectedKiraTokensBN = usdAmountBN
          .mul(ethers.BigNumber.from(10).pow(18))
          .div(window.currentPriceBN || ethers.utils.parseUnits("100", 18)); // fallback if not set
        const tolerance = expectedKiraTokensBN.mul(1).div(100);
        const minTokensBN = expectedKiraTokensBN.sub(tolerance);
        const expectedKiraTokens = parseFloat(
          ethers.utils.formatUnits(expectedKiraTokensBN, 18)
        );
        document.getElementById("bnbKiraPreview").value =
          expectedKiraTokens.toFixed(4);
        // Assume bnbPrice is set (you may update this from an API)
        const bnbPrice = window.bnbPrice || 300; // fallback value
        const bnbEquivalent = usdVal / bnbPrice;
        document.getElementById("bnbEquivalentPreview").value =
          bnbEquivalent.toFixed(6);
      }

      // Function to purchase with stablecoin.
      async function buyWithStablecoin() {
        const stablecoinSelect =
          document.getElementById("stablecoinSelect").value;
        const usdVal = parseFloat(
          document.getElementById("stablecoinAmount").value
        );
        if (isNaN(usdVal) || usdVal <= 0) {
          alert("Enter a valid USD amount");
          return;
        }
        const kiraTokens = usdVal / 100;
        const kiraTokensStr = kiraTokens.toFixed(18);
        const tokenAmount = ethers.utils.parseUnits(kiraTokensStr, 18);
        const totalPriceStable = ethers.utils.parseUnits(usdVal.toString(), 18);
        try {
          const stable = new ethers.Contract(
            stablecoins[stablecoinSelect].address,
            ["function approve(address,uint256) public returns (bool)"],
            ethersSigner
          );
          const approveTx = await stable.approve(
            dappContractAddress,
            totalPriceStable
          );
          await approveTx.wait();
          const tx = await dappContract.buyWithStablecoin(
            stablecoins[stablecoinSelect].address,
            tokenAmount
          );
          await tx.wait();
          alert("Stablecoin purchase successful!");
          updateContractStats();
        } catch (error) {
          console.error("Stablecoin purchase failed:", error);
          alert("Purchase failed: " + error.message);
        }
      }

      // Function to purchase with native currency (BNB).
      async function buyWithNative() {
        const usdVal = parseFloat(
          document.getElementById("bnbUsdAmount").value
        );
        if (isNaN(usdVal) || usdVal <= 0) {
          alert("Enter a valid USD amount");
          return;
        }
        const bnbEquivalent = usdVal / (window.bnbPrice || 300);
        const bnbEquivalentStr = bnbEquivalent.toFixed(18);
        const bnbValue = ethers.utils.parseEther(bnbEquivalentStr);
        const usdAmountBN = ethers.utils.parseUnits(usdVal.toString(), 18);
        const expectedKiraTokensBN = usdAmountBN
          .mul(ethers.BigNumber.from(10).pow(18))
          .div(window.currentPriceBN || ethers.utils.parseUnits("100", 18));
        const tolerance = expectedKiraTokensBN.mul(1).div(100);
        const minTokensBN = expectedKiraTokensBN.sub(tolerance);
        try {
          const tx = await dappContract.buyWithNative(minTokensBN, {
            value: bnbValue,
          });
          await tx.wait();
          alert("Native purchase successful!");
          updateContractStats();
        } catch (error) {
          console.error("BNB purchase failed:", error);
          alert("Purchase failed: " + error.message);
        }
      }

      // Attach event listeners for purchase inputs and buttons.
      document
        .getElementById("stablecoinAmount")
        .addEventListener("input", updateStablecoinPreview);
      document
        .getElementById("bnbUsdAmount")
        .addEventListener("input", updateNativePreview);
      document
        .getElementById("buyStablecoinButton")
        .addEventListener("click", buyWithStablecoin);
      document
        .getElementById("buyNativeButton")
        .addEventListener("click", buyWithNative);

      // Attach event listener to the Connect Wallet button.
      document
        .getElementById("connectWalletButton")
        .addEventListener("click", connectWallet);

      // Optionally, you may auto-trigger connection on page load:
      // window.addEventListener("load", connectWallet);
    </script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
